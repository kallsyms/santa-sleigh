#!/bin/sh
set -eu

CONF_DIR="/Library/Application Support/SantaSleigh"
LOG_DIR="/Library/Logs/SantaSleigh"
PLIST="/Library/LaunchDaemons/com.kallsyms.santa-sleigh.plist"
CONFIG_FILE="$CONF_DIR/config.toml"
SAMPLE="$CONF_DIR/config.toml.sample"

/bin/mkdir -p "$CONF_DIR"
/bin/chmod 0755 "$CONF_DIR"
/bin/mkdir -p "$LOG_DIR"
/bin/chmod 0755 "$LOG_DIR"

if [ ! -f "$CONFIG_FILE" ] && [ -f "$SAMPLE" ]; then
  /bin/cp "$SAMPLE" "$CONFIG_FILE"
  /bin/chmod 0640 "$CONFIG_FILE"
fi

/usr/sbin/chown root:wheel "$PLIST"
/bin/chmod 0644 "$PLIST"

/bin/launchctl bootout system "$PLIST" 2>/dev/null || true
/bin/launchctl bootstrap system "$PLIST" 2>/dev/null || true
/bin/launchctl enable system/com.kallsyms.santa-sleigh 2>/dev/null || true
/bin/launchctl kickstart -k system/com.kallsyms.santa-sleigh 2>/dev/null || true

exit 0
